# Search-based Refinement

SafeQL refines SQL queries generated by LLMs using a **search-based refinement** mechanism.  
This section explains how to refine queries using SafeQL.

---

## 1. Prerequisites

Before using SafeQL, ensure that the vector extension is enabled.

```sql
LOAD 'vectors';
SET search_path TO "$user", public, vectors;
```

If you haven't configured vector backends or loaded metadata yet,  
refer to the **Data Loading** tab in this documentation.

---

## 2. Example Dataset

To illustrate SafeQL's behavior, consider a simple schema:

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    name TEXT,
    age INTEGER
);

INSERT INTO users VALUES
    (1, 'Alice', 22),
    (2, 'Bob', 35),
    (3, 'Charlie', 29);
```

---

## 3. Refinement-only: Generate Corrected SQL

The simplest way to use SafeQL is to **generate the corrected SQL only** (without executing it):

### Example — Correcting a broken SELECT

```sql
SELECT safeql_to_sql($$
    SELECT username FROM user WHERE ages > 20;
$$);
```

SafeQL will:

- Recognize `users` (not `user`)  
- Recognize `name` (not `username`)  
- Recognize `age` (not `ages`)  

And it will output something like:

```sql
SELECT name FROM users WHERE age > 20;
```


## 4. Refinement + Execution Combined 

SafeQL can not only generate the corrected SQL, but **also execute it and return the actual result rows.** 

### Example — Correct + Execute 

```sql 
SELECT safeql($$ 
SELECT username FROM user WHERE ages > 20; 
$$) AS t(result TEXT); 
```

Expected output: 
``` 
{"name": "Bob"} 
{"name": "Charlie"} 
``` 
